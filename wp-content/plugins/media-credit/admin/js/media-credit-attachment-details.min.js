/*! media-credit media-credit-attachment-details.js 2018-02-21 1:07:53 AM */

jQuery(function(e){"use strict";var t=window.$mediaCredit||{};t.autoComplete=function(a,i,d){var n=function(e){a.model.set({mediaCreditAuthorID:"",mediaCreditAuthorDisplay:e,mediaCreditText:e}),d&&a.model.save()};return a.$el.find(i).autocomplete({autoFocus:!0,minLength:2,source:t.names||(t.names=_.map(t.id,function(e,t){return{id:t,value:e,label:e}})),select:function(t,i){return e(this).attr("value",i.item.value),a.model.set({mediaCreditAuthorID:i.item.id,mediaCreditAuthorDisplay:i.item.value,mediaCreditText:i.item.value}),d&&a.model.save(),!1},response:function(t,i){var d;0===i.content.length&&(d=e(this).val())!==a.model.get("mediaCreditAuthorDisplay")&&n(d)},open:function(){return e(this).autocomplete("widget").css("z-index",2e6),!1}}).click(function(){this.select()}).change(function(i){var o=e(this),m=o.val();(t.noDefaultCredit||!1)&&""===m&&""===a.model.get("mediaCreditAuthorID")?(a.model.set({mediaCreditAuthorID:a.model.get("author"),mediaCreditAuthorDisplay:a.model.get("authorName"),mediaCreditText:a.model.get("authorName")}),d&&a.model.save(),o.val("").attr("placeholder",a.model.get("mediaCreditAuthorDisplay")),i.stopImmediatePropagation(),i.preventDefault()):m!==a.model.get("mediaCreditAuthorDisplay")&&(n(m),i.stopImmediatePropagation(),i.preventDefault())})},wp.media.view.Attachment.Details&&(t.AttachmentDetails=wp.media.view.Attachment.Details.extend({template:function(e){return wp.media.template("attachment-details")(e)+wp.media.template("media-credit-attachment-details")(e)},render:function(){var e,a=t.noDefaultCredit||!1;wp.media.view.Attachment.prototype.render.apply(this,[]),e=t.autoComplete(this,'label[data-setting="mediaCreditText"] input[type="text"]',!0),a?(e.autocomplete("disable"),""!==this.model.get("mediaCreditAuthorID")&&e.val("").attr("placeholder",this.model.get("mediaCreditAuthorDisplay"))):e.autocomplete("enable")},updateSetting:function(t){var a=e(t.target);a.is('input[type="checkbox"]')&&(t.target.value=a.prop("checked")),wp.media.view.Attachment.prototype.updateSetting.apply(this,[t])}}),wp.media.view.Attachment.Details.prototype=t.AttachmentDetails.prototype),wp.media.view.Attachment.Details.TwoColumn&&(t.AttachmentDetailsTwoColumn=wp.media.view.Attachment.Details.TwoColumn.extend({template:function(t){var a=e(e.parseHTML(wp.media.template("attachment-details-two-column")(t)));return e(wp.media.template("media-credit-attachment-details")(t)).insertAfter(a.find(".attachment-compat").prevAll("*[data-setting]")[0]),a},updateSetting:function(e){wp.media.view.Attachment.Details.prototype.updateSetting.apply(this,[e])}}),wp.media.view.Attachment.Details.TwoColumn.prototype=t.AttachmentDetailsTwoColumn.prototype),wp.media.model.Attachment&&(t.AttachmentModel=wp.media.model.Attachment.extend({sync:function(a,i,d){var n,o=null;return _.isUndefined(this.id)?e.Deferred().rejectWith(this).promise():("update"===a&&i.hasChanged()&&(n=this.get("nonces"))&&n.mediaCredit&&n.mediaCredit.update&&((d=d||{}).context=this,d.data=_.extend(d.data||{},{action:"save-attachment-media-credit",id:this.id,nonce:n.mediaCredit.update,post_id:wp.media.model.settings.post.id}),i.hasChanged()&&(d.data.changes={},d.data.mediaCredit={},t.noDefaultCredit&&""===i.changed.mediaCreditText&&""!==i.get("mediaCreditAuthorID")&&delete i.changed.mediaCreditText,_.each(i.changed,function(e,t){0===t.indexOf("mediaCredit")&&(d.data.changes[t]=this.get(t),delete i.changed[t])},this),d.data.mediaCredit.text=i.get("mediaCreditText"),d.data.mediaCredit.link=i.get("mediaCreditLink"),d.data.mediaCredit.id=i.get("mediaCreditAuthorID"),d.data.mediaCredit.nofollow=i.get("mediaCreditNoFollow")),_.size(d.data.changes)>0&&(o=wp.media.ajax(d),delete d.data.changes,this.updateMediaCreditInEditorContent(e("textarea#content").val(),d),delete d.data.mediaCredit)),"update"!==a||i.hasChanged()?this.constructor.__super__.sync.apply(this,[a,i,d]):o||e.Deferred().rejectWith(this).promise())},updateMediaCreditInEditorContent:function(t,a){var i,d=this.get("nonces");t&&d&&d.mediaCredit&&d.mediaCredit.content&&(i=_.extend(a,{data:_.extend(a.data,{action:"update-media-credit-in-post-content",nonce:d.mediaCredit.content,mediaCredit:_.extend(a.data.mediaCredit,{content:t})}),success:function(a){var i;t!==a&&((i=tinymce.get("content"))&&i instanceof tinymce.Editor&&e("#wp-content-wrap").hasClass("tmce-active")?(i.setContent(a),i.save({no_events:!0})):e("textarea#content").val(a))}}),wp.media.ajax("update-media-credit-in-post-content",i))}}),wp.media.model.Attachment.prototype=t.AttachmentModel.prototype)});