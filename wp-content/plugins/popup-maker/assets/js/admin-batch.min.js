"use strict";!function(e){var a={form:{beforeSubmit:function(a){var t=a.find('.pum-field-submit input[type="submit"]'),r=a.find(".pum-upgrade-messages"),s=a.find(".pum-batch-progress"),n=a.data("ays");return!t.hasClass("button-disabled")&&(!(void 0!==n&&!confirm(n))&&(s.removeClass("pum-batch-progress--active"),s.find("progress").prop("value",null),r.html(""),t.addClass("button-disabled"),e('<span class="spinner is-active"></span>').insertAfter(t),!0))}},complete:function(a){var t=a.parents(".notice");a.find(".pum-field-submit, progress").hide(),e("p.pum-upgrade-notice").hide(),t.removeClass("notice-info").addClass("notice-success  notice-alt"),t.prepend("<h2>"+pum_batch_vars.complete+"</h2>")},action:"pum_process_batch_request",process_step:function(a,t){var r=this;e.ajax({type:"POST",url:ajaxurl,data:{batch_id:t.batch_id,action:r.action,nonce:t.nonce,form:t.form,step:parseInt(a),data:t},dataType:"json",success:function(a){if(a.data.done||a.data.error){var s=a.data.mapping?".pum-batch-import-form":".pum-batch-form",n=e(s),i=n.find(".spinner"),o=n.find(".notice-wrap");n.find(".button-disabled").removeClass("button-disabled"),a.data.error?(i.remove(),o.html('<div class="updated error"><p>'+a.data.error+"</p></div>")):a.data.done?(i.remove(),o.html('<div id="pum-batch-success" class="updated notice"><p class="pum-batch-success">'+a.data.message+"</p></div>"),a.data.url&&(window.location=a.data.url)):o.remove()}else e(".pum-batch-progress div").animate({width:a.data.percentage+"%"},50),r.process_step(a.data.step,t)}}).fail(function(e){window.console&&window.console.log&&console.log(e)})}},t=e.extend({},a,{action:"pum_process_batch_import",before_submit:function(a,t){var r=e(".pum-batch-import-form").find(".pum-batch-progress").parent().parent(),s=r.find(".notice-wrap");if(t.find(".notice-wrap").remove(),t.append('<div class="notice-wrap"><span class="spinner is-active"></span><div class="pum-batch-progress"><div></div>'),!(window.File&&window.FileReader&&window.FileList&&window.Blob))return r.find(".button-disabled").removeClass("button-disabled"),s.html('<div class="update error"><p>'+pum_batch_vars.unsupported_browser+"</p></div>"),!1},success:function(e,a,t,r){console.log(r)},complete:function(t){var r=jQuery.parseJSON(t.responseText),s=this;if(r.success){var n,i,o,d=e(".pum-batch-import-form .notice-wrap").parent(),p=d.find("select.pum-import-csv-column"),c="",u=r.data.columns.sort(function(e,a){return e<a?-1:e>a?1:0});d.find(".pum-import-file-wrap, .notice-wrap").remove(),d.find(".pum-import-options").slideDown(),e.each(p,function(a,t){var s=e(this);n=e(t).attr("name"),e.each(u,function(e,a){var t=a.toLowerCase().replace(/ /g,"_"),i=new RegExp("\\["+t+"\\]"),o=!(!n.length||!n.match(i))&&' selected="selected"';o&&s.parent().next().html(!1!==r.data.first_row[a]?r.data.first_row[a]:""),c+='<option value="'+a+'"'+o+">"+a+"</option>"}),s.append(c),c=""}),p.on("change",function(){var a=e(this),t=a.val(),s="";t&&!1!==r.data.first_row[t]&&(s=r.data.first_row[t]),a.parent().next().html(s)}),e("body").on("click",".pum-import-proceed",function(t){if(t.preventDefault(),d.data("required")){var s=d.data("required"),n=[];n=s.indexOf(",")?s.split(","):[s];var p=!1;if(e.each(n,function(a,t){i=e("select[name='pum-import-field["+t+"]']"),o=i.parent().parent(),o.removeClass("pum-required-import-field"),""===i.val()&&(p=!0,o.addClass("pum-required-import-field"),i.parent().next().html(pum_batch_vars.import_field_required))}),p)return}d.find(".notice-wrap").remove(),e(this).parent().append('<span class="spinner is-active"></span>'),d.append('<div class="notice-wrap"><div class="pum-batch-progress"><div></div>'),r.data.mapping=d.serialize(),r.data.form=d.serializeAssoc(),a.process_step(1,r.data)})}else s.error(t)},error:function(a){var t=jQuery.parseJSON(a.responseText),r=e(".pum-batch-import-form").find(".pum-batch-progress").parent().parent(),s=r.find(".notice-wrap");r.find(".button-disabled").removeClass("button-disabled"),t.data.error?s.html('<div class="update error"><p>'+t.data.error+"</p></div>"):s.remove()}}),r=e.extend(!0,{},a,{action:"pum_process_upgrade_request",process_step:function(t,r){var s=this;e.ajax({type:"POST",url:ajaxurl,data:{upgrade_id:r.upgrade_id,action:s.action,nonce:r.nonce,form:r.form,step:parseInt(t),data:r},dataType:"json",success:function(t){var n=e(".pum-upgrade-form"),i=n.find(".spinner"),o=n.find(".button-disabled"),d=n.find(".pum-upgrade-messages");t.data.done||t.data.error?(o.removeClass("button-disabled"),t.data.error?(i.remove(),d.prepend('<div class="notice notice-error notice-alt"><p>'+t.data.error+"</p></div>")):t.data.done?(d.prepend('<div class="notice notice-success"><p><strong>'+t.data.message+"</strong></p></div>"),t.data.next?(n.data("upgrade_id",t.data.next).data("step",1).data("ays",!1),s.process_step(1,{upgrade_id:t.data.next,nonce:r.nonce,form:r.form})):(o.parent().hide(),i.remove(),a.complete(n)),t.data.url&&(window.location=t.data.url)):""!==t.data.message&&d.prepend('<div class="notice"><p class="">'+t.data.message+"</p></div>")):(""!==t.data.message&&d.prepend('<div class="notice"><p class="">'+t.data.message+"</p></div>"),e(".pum-batch-progress").addClass("pum-batch-progress--active"),e(".pum-batch-progress progress.pum-task-progress").addClass("active").val(t.data.percentage),s.process_step(t.data.step,r))}}).fail(function(e){window.console&&window.console.log&&console.log(e)})}});window.PUM_Admin=window.PUM_Admin||{},window.PUM_Admin.batch=a,window.PUM_Admin.batch_import=t,window.PUM_Admin.batch_upgrades=r,e(document).on("submit",".pum-batch-form[data-batch_id]",function(t){var r=e(this),s=r.find('input[type="submit"]'),n=r.data("ays"),i={batch_id:r.data("batch_id"),nonce:r.data("nonce"),form:r.serializeAssoc(),test:r.pumSerializeObject()};if(t.preventDefault(),!s.hasClass("button-disabled")){if(void 0!==n&&!confirm(n))return;r.find(".notice-wrap").remove(),r.append(e('<div class="notice-wrap"><div class="pum-batch-progress"><div></div>')),s.addClass("button-disabled"),s.parent().append('<span class="spinner is-active"></span>'),a.process_step(1,i)}}).on("submit",".pum-batch-form.pum-upgrade-form[data-upgrade_id]",function(a){var t=e(this),s={upgrade_id:t.data("upgrade_id"),nonce:t.data("nonce"),form:t.serializeAssoc(),test:t.pumSerializeObject()};a.preventDefault(),r.form.beforeSubmit(t)&&r.process_step(t.data("step")||1,s)}).ready(function(){e(".pum-batch-import-form").each(function(){var a=e(this);a.ajaxForm({beforeSubmit:t.before_submit,complete:t.complete,dataType:"json",error:t.error,data:{action:t.action,batch_id:a.data("batch_id"),nonce:a.data("nonce")},url:ajaxurl,resetForm:!0})})})}(jQuery),jQuery(document).ready(function(e){e.extend({arrayMerge:function(){for(var a={},t=0,r=e.arrayMerge.arguments,s=0;s<r.length;s++)if(Array.isArray(r[s])){for(var n=0;n<r[s].length;n++)a[t++]=r[s][n];a=e.makeArray(a)}else for(var i in r[s])if(r[s].hasOwnProperty(i))if(isNaN(i)){var o=r[s][i];"object"==typeof o&&a[i]&&(o=e.arrayMerge(a[i],o)),a[i]=o}else a[t++]=r[s][i];return a},count:function(e){return Array.isArray(e)?e.length:"object"==typeof e&&Object.keys(e).length}}),e.fn.extend({serializeAssoc:function(){for(var a={aa:{},add:function(a,t){var r=a.match(/^(.*)\[([^\]]*)]$/),s={};r?(r[2]?s[r[2]]=t:s[e.count(s)]=t,this.add(r[1],s)):"object"==typeof t?("object"!=typeof this.aa[a]&&(this.aa[a]={}),this.aa[a]=e.arrayMerge(this.aa[a],t)):this.aa[a]=t}},t=e(this).serializeArray(),r=0;r<t.length;r++)a.add(t[r].name,t[r].value);return a.aa}})});