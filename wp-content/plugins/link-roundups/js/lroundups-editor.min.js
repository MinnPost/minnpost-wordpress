!function(){var n=jQuery,d="roundup_block",t=Backbone.Model.extend({idAttribute:"ID",saving:!1,getStatus:function(){var t=this.get("post_status");return"private"==t?"Privately Published":"publish"==t?"Published":"future"==t?"Scheduled":"pending"==t?"Pending Review":"draft"==t||"auto-draft"==t?"Draft":t},save:function(t,e){var s=this;if(this.saving)return!1;void 0!==t&&this.set(t),this.saving=!0,n.ajax({url:ajaxurl,dataType:"json",method:"post",data:{action:"roundup_update_post",security:LR.ajax_nonce,post:JSON.stringify(this.toJSON())},success:function(t){s.saving=!1,void 0!==e.success&&e.success(this)}})}}),s=Backbone.Collection.extend({model:t}),i=LR.Modal.extend({className:"link-edit-modal",content:"",actions:{Update:"update",Cancel:"close"},initialize:function(t){this.controller=t.controller,LR.Modal.prototype.initialize.apply(this,arguments)},render:function(){var t=_.template(n("#lroundups-post-edit-tmpl").html());return this.content=t(this.model.toJSON()),this.controller.hide(),LR.Modal.prototype.render.apply(this,arguments),this},close:function(){if(this.model.saving)return!1;this.controller.show(),LR.Modal.prototype.close.apply(this,arguments)},update:function(){if(this.model.saving)return!1;var t=this,e=this.$el.find(":input").serializeObject();return this.disableActions(),this.showSpinner(),this.model.save(e,{success:function(){t.hideSpinner(),t.close(),t.controller.renderAdded()}}),!1},disableActions:function(){this.$el.find(".lroundups-modal-actions .button").addClass("disabled")}}),e=LR.Modal.extend({className:"roundup-block-modal",content:"",searchFields:["post_title","post_content","post_excerpt"],addedPosts:new s,actions:{Save:"save",Close:"close"},events:{"click .remove":"removePost","click .close":"close","click .edit":"editLink","click .add":"addLink"},render:function(){var i=this,t=_.template(n("#lroundups-posts-tmpl").html()),o=[];if(this.content=t({name:this.name,hasPosts:void 0!==this.ids}),LR.Modal.prototype.render.apply(this,arguments),this.showSpinner(),!(this.posts.length<=0)){if(void 0!==this.ids){var e=this.ids.split(",");_.each(e,function(t,e){var s=i.posts.findWhere({ID:Number(t)});s&&o.push(s)})}return 0<o.length&&(this.addedPosts.add(o),this.posts.remove(o)),this.renderAdded(),this.renderAvailable(),this.setupTypehead(),this.connectSortables(),this.hideSpinner(),this}},save:function(t){var e=_.map(this.$el.find(".added-posts li"),function(t,e){return n(t).data("id")}),i="["+d+' ids="'+e.join(",")+'" name="'+this.name+'"]',o=this;this.shortcode.getNodes(function(t,e,s){o.shortcode.update(i,t,e),o.editor.focus(),o.close()})},renderAvailable:function(){if(this.posts.length<=0)return!1;this.$el.find(".loading").remove();var t=_.template(n("#lroundups-post-tmpl").html())({posts:this.posts});this.$el.find(".available-posts").html(t),void 0!==this.lastQuery&&this.lastQuery&&this.queryCallback(this.lastQuery)},renderAdded:function(){if(this.addedPosts.length<=0)return this.$el.find(".added-posts").html('<li class="no-posts">No items have been added.</li>'),!1;var t=_.template(n("#lroundups-post-tmpl").html())({posts:this.addedPosts});this.$el.find(".added-posts").html(t)},connectSortables:function(){this.$el.find(".sortable").sortable({connectWith:".connected",placeholder:"ui-state-highlight",forcePlaceholderSize:!0}),this.$el.find(".sortable").on("sortstart",function(t,e){n("body").addClass("sorting")}),this.$el.find(".sortable").on("sortdeactivate",function(t,e){n("body").removeClass("sorting")}),this.$el.find(".sortable").on("sortreceive",this.sortReceive.bind(this)),this.$el.find(".sortable.added-posts").on("sortstop",this.sortStop.bind(this))},sortReceive:function(t,e){var s,i=this,o=n(t.target),d=e.item;o.hasClass("added-posts")?(o.find(".no-posts").remove(),s=i.posts.findWhere({ID:d.data("id")}),i.addedPosts.add([s]),i.posts.remove([s]),i.renderAdded()):o.hasClass("available-posts")&&(s=i.addedPosts.findWhere({ID:d.data("id")}),i.posts.add([s]),i.addedPosts.remove([s]))},sortStop:function(t,e){var s=this,i=(n(t.target),e.item),o=i.parent().find("li").index(i);post=s.addedPosts.findWhere({ID:i.data("id")}),s.addedPosts.remove([post],{silent:!0}),s.addedPosts.add([post],{at:o})},editLink:function(t){var e=n(t.currentTarget),s=this.addedPosts.findWhere({ID:e.data("id")});return new i({model:s,controller:this}).render(),!1},addLink:function(t){var e=n(t.currentTarget),s=e.closest("li"),i=this.posts.findWhere({ID:e.data("id")});return this.posts.remove([i]),this.addedPosts.add([i]),this.renderAdded(),s.remove(),!1},removePost:function(t){var e=n(t.currentTarget),s=this.addedPosts.findWhere({ID:e.data("id")}),i=e.closest("li");return this.posts.add([s]),this.addedPosts.remove([s]),this.renderAvailable(),i.remove(),!1},setupTypehead:function(){var t=this;t.$el.find(".typeahead").typeahead({minLength:3,highlight:!0},{name:"posts",source:t.queryCallback.bind(t)}),t.$el.find(".typeahead").removeAttr("disabled"),t.$el.find(".typeahead").on("input",function(){""==n(this).val()&&(t.$el.find(".available-posts li").show(),t.lastQuery=null)})},queryCallback:function(i,t,e){var o=this,d={};i=i.toLowerCase(),o.posts.each(function(s){_.each(o.searchFields,function(t,e){0<=s.get(t).toLowerCase().indexOf(i)&&(d[s.get("ID")]||(d[s.get("ID")]=s))})}),o.filterList(d),o.lastQuery=i},filterList:function(t){var e=_.keys(t);this.$el.find(".available-posts li").hide(),this.$el.find(".available-posts li").each(function(){0<=_.indexOf(e,String(n(this).data("id")))&&n(this).show()})}});wp.mce.roundup_block={template:_.template('<div class="lr-block"><span class="lr-block-name"><% if (typeof name !== "undefined" ) { %><%= name %><% } else { %>Link Roundup Block<% } %></span><% if (posts.length > 0 ) { %><ul><% posts.each(function(post) { %><li><%= post.get("post_title") %></li><% }) %></ul><% } %></div>'),getContent:function(){var t=this.shortcode.attrs.named,i=new s(LR.roundup_posts),o=[];if(void 0!==t.ids){var e=t.ids.split(",");_.each(e,function(t,e){var s=i.findWhere({ID:Number(t)});s&&o.push(s)})}return t.innercontent=this.shortcode.content,t.posts=new s(o),this.template(t)},edit:function(t,e){var s=wp.shortcode.next(d,t).shortcode.attrs.named;wp.mce.roundup_block.fetchStories(tinyMCE.activeEditor,s,this)},fetchStories:function(t,e,s){this.values=e,this.editor=t,this.shortcode=s,this.setupModal()},setupModal:function(t){this.modal=new e,this.modal.posts=new s(LR.roundup_posts),this.modal.posts.comparator="order",this.modal.posts.on("reset",this.modal.render.bind(this.modal)),this.modal.addedPosts=new s,this.modal.name=this.values.name,this.modal.ids=this.values.ids,this.modal.editor=this.editor,this.modal.shortcode=this.shortcode,this.modal.render()}},n(document).ready(function(){wp.mce.views.register(d,wp.mce.roundup_block)})}();